{"generator":"Code Snippets v3.6.8","date_created":"2025-06-13 05:52","snippets":[{"id":44,"name":"apply discount on cart","code":"\n\/\/ Enqueue inline JavaScript for AJAX coupon application, notices, and dynamic total update\nadd_action('wp_footer', 'add_custom_coupon_script_and_notices');\nfunction add_custom_coupon_script_and_notices() {\n    if (is_checkout()) {\n        \/\/ Get current cart totals for JavaScript\n        $subtotal = WC()->cart->get_subtotal() * 1.25; \/\/ Mimic shortcode's VAT adjustment\n        $discount_total = WC()->cart->get_discount_total();\n        $total = $subtotal - $discount_total; \/\/ Correct total after discount\n        ?>\n        <script type=\"text\/javascript\">\n            jQuery(document).ready(function($) {\n                \/\/ Apply coupon via AJAX\n                $('.discount-code-container .activate-btn').on('click', function(e) {\n                    e.preventDefault();\n                    var $container = $(this).closest('.discount-code-container');\n                    var couponCode = $container.find('.discount-input').val().trim();\n                    if (!couponCode) {\n                        alert('Vennligst skriv inn en rabattkode.');\n                        return;\n                    }\n                    $.ajax({\n                        url: '<?php echo admin_url('admin-ajax.php'); ?>',\n                        type: 'POST',\n                        data: {\n                            action: 'apply_custom_coupon',\n                            coupon_code: couponCode,\n                            nonce: '<?php echo wp_create_nonce('apply-coupon'); ?>'\n                        },\n                        success: function(response) {\n                            if (response.success) {\n                                alert(response.data.message);\n                                \/\/ Update Totalpris dynamically\n                                $.ajax({\n                                    url: '<?php echo admin_url('admin-ajax.php'); ?>',\n                                    type: 'POST',\n                                    data: {\n                                        action: 'get_updated_cart_totals'\n                                    },\n                                    success: function(totals) {\n                                        if (totals.success) {\n                                            $('.summary-row.total .woocommerce-Price-amount').html(totals.data.total_html);\n                                        }\n                                        location.reload(); \/\/ Reload to ensure all totals are consistent\n                                    }\n                                });\n                            } else {\n                                alert(response.data.message);\n                            }\n                        },\n                        error: function(xhr, status, error) {\n                            alert('Feil ved bruk av rabattkode. Pr\u00f8v igjen.');\n                            console.log('AJAX Error:', xhr.responseText);\n                        }\n                    });\n                });\n\n                \/\/ Initial Totalpris correction on page load\n                var currentTotal = '<?php echo wc_price($total); ?>';\n                $('.summary-row.total .woocommerce-Price-amount').html(currentTotal);\n            });\n        <\/script>\n        <div class=\"woocommerce-notices-wrapper\">\n            <?php wc_print_notices(); ?>\n        <\/div>\n        <?php\n    }\n}\n\n\/\/ AJAX handler for applying coupons\nadd_action('wp_ajax_apply_custom_coupon', 'apply_custom_coupon_callback');\nadd_action('wp_ajax_nopriv_apply_custom_coupon', 'apply_custom_coupon_callback');\nfunction apply_custom_coupon_callback() {\n    check_ajax_referer('apply-coupon', 'nonce');\n    $coupon_code = isset($_POST['coupon_code']) ? sanitize_text_field($_POST['coupon_code']) : '';\n\n    if (empty($coupon_code)) {\n        wp_send_json_error(['message' => __('Ingen rabattkode angitt.')]);\n        wp_die();\n    }\n\n    if (WC()->cart) {\n        $result = WC()->cart->apply_coupon($coupon_code);\n        if ($result) {\n            WC()->cart->calculate_totals(); \/\/ Ensure totals are updated\n            wp_send_json_success(['message' => __('Rabattkode brukt!')]);\n        } else {\n            $notices = wc_get_notices('error');\n            $error_message = !empty($notices) ? end($notices)['notice'] : __('Ugyldig rabattkode eller kupongen kan ikke brukes.');\n            wp_send_json_error(['message' => $error_message]);\n        }\n    } else {\n        wp_send_json_error(['message' => __('Feil: Handlekurv ikke initialisert.')]);\n    }\n    wp_die();\n}\n\n\/\/ AJAX handler to get updated cart totals\nadd_action('wp_ajax_get_updated_cart_totals', 'get_updated_cart_totals_callback');\nadd_action('wp_ajax_nopriv_get_updated_cart_totals', 'get_updated_cart_totals_callback');\nfunction get_updated_cart_totals_callback() {\n    if (WC()->cart) {\n        $subtotal = WC()->cart->get_subtotal() * 1.25; \/\/ Mimic shortcode's VAT adjustment\n        $discount_total = WC()->cart->get_discount_total();\n        $total = $subtotal - $discount_total; \/\/ Correct total\n        wp_send_json_success([\n            'total_html' => wc_price($total)\n        ]);\n    } else {\n        wp_send_json_error(['message' => __('Feil: Handlekurv ikke initialisert.')]);\n    }\n    wp_die();\n}\n\n\/\/ Ensure cart totals are recalculated\nadd_action('woocommerce_cart_calculate_totals', 'ensure_discount_applied_in_total', 20);\nfunction ensure_discount_applied_in_total($cart) {\n    if (is_admin() && !defined('DOING_AJAX')) {\n        return;\n    }\n    $cart->calculate_totals();\n}","active":true,"modified":"2025-05-09 15:36:04","revision":"11"}]}
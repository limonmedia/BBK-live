{"generator":"Code Snippets v3.6.8","date_created":"2025-06-13 05:52","snippets":[{"id":38,"name":"show coupons on account dashboard","code":"\nfunction display_user_valid_coupons_shortcode() {\n    if (!is_user_logged_in()) {\n        return '';\n    }\n\n    $user = wp_get_current_user();\n    $user_email = $user->user_email;\n    $user_id = $user->ID;\n\n    \/\/ Get hidden coupons for this user\n    $hidden_coupons = get_user_meta($user_id, 'hidden_coupons', true);\n    if (!is_array($hidden_coupons)) {\n        $hidden_coupons = [];\n    }\n\n    $args = array(\n        'post_type'      => 'shop_coupon',\n        'posts_per_page' => -1,\n        'post_status'    => 'publish',\n    );\n\n    $coupons = get_posts($args);\n    $valid_coupons = [];\n\n    foreach ($coupons as $coupon_post) {\n        $coupon = new WC_Coupon($coupon_post->post_title);\n\n        \/\/ Skip if user has hidden this coupon\n        if (in_array($coupon->get_code(), $hidden_coupons)) {\n            continue;\n        }\n\n        $restricted_emails = $coupon->get_email_restrictions();\n        $usage_limit_per_user = $coupon->get_usage_limit_per_user();\n\n        $is_user_allowed = false;\n\n        if (!empty($restricted_emails)) {\n            if (in_array($user_email, $restricted_emails)) {\n                $is_user_allowed = true;\n            }\n        } else {\n            continue;\n        }\n\n        if ($is_user_allowed && $usage_limit_per_user > 0) {\n            $user_usage_count = $coupon->get_data_store()->get_usage_by_user_id($coupon->get_id(), $user_id);\n            if ($user_usage_count >= $usage_limit_per_user) {\n                $is_user_allowed = false;\n            }\n        }\n\n        if ($is_user_allowed) {\n            $discounts = new WC_Discounts(WC()->cart);\n            $result = $discounts->is_coupon_valid($coupon);\n\n            if (!is_wp_error($result)) {\n                $valid_coupons[] = $coupon;\n            }\n        }\n    }\n\n    $output = '';\n    if (!empty($valid_coupons)) {\n        $output .= '<div style=\"display: flex; flex-wrap: nowrap; gap: 20px; margin-top: 10px; justify-content: flex-start;\">';\n\n        $counter = 0;\n\n        foreach ($valid_coupons as $coupon) {\n            $amount = $coupon->get_amount();\n            $discount_type = $coupon->get_discount_type();\n            $description = $coupon->get_description();\n            $coupon_id = 'coupon-code-' . $counter;\n            $coupon_code = $coupon->get_code();\n\n            $output .= '<div class=\"coupon-card\" data-coupon=\"' . esc_attr($coupon_code) . '\" id=\"card-' . esc_attr($coupon_id) . '\" style=\"width: 200px; background: white; border: 1px solid #ddd; padding: 5px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); box-sizing: border-box;\">';\n            $output .= '<div style=\"background: #eae8ed; color: #d20a11; padding: 10px; border-radius: 8px; text-align: center;\">';\n\n            if ($discount_type === 'percent') {\n                $output .= '<div style=\"font-size: 50px; font-family:Barlow; font-weight: bold; color: #d20a11;\">-' . esc_html($amount) . '%<\/div>';\n            } elseif ($discount_type === 'fixed_cart') {\n                $output .= '<div style=\"font-size: 50px; font-family:Barlow; font-weight: bold; color: #d20a11;\">' . wc_price($amount) . '<\/div>';\n                $output .= '<div style=\"font-size: 20px; font-family:Barlow;\">off your cart*<\/div>';\n            } elseif ($discount_type === 'fixed_product') {\n                $output .= '<div style=\"font-size: 50px; font-family:Barlow; font-weight: bold; color: #d20a11;\">' . wc_price($amount) . '<\/div>';\n                $output .= '<div style=\"font-size: 20px; font-family:Barlow;\">off per item*<\/div>';\n            }\n\n            $output .= '<\/div>';\n            $output .= '<div style=\"padding: 15px; color: #333;\">';\n            $output .= '<p style=\"font-size: 8px; text-align:center; color: #666; font-family:Barlow;\">';\n\n            if ($description) {\n                $output .= esc_html($description) . '<br>';\n            } else {\n                if ($discount_type === 'percent') {\n                    $output .= 'Vi har gitt deg en rabattkode p\u00e5 '.esc_html($amount) . '% i v\u00e5r nettbutikk.<br>';\n                } elseif ($discount_type === 'fixed_cart') {\n                    $output .= wc_price($amount) . ' off your cart*<br>';\n                } elseif ($discount_type === 'fixed_product') {\n                    $output .= wc_price($amount) . ' off per item*<br>';\n                }\n            }\n\n            $output .= '<\/p>';\n            $output .= '<div style=\"text-align: center;\">';\n            $output .= '<button onclick=\"showCouponCode(\\'' . esc_js($coupon_id) . '\\', \\'' . esc_js($coupon_code) . '\\')\" style=\"font-size: 10px; background: white; color: black; border: 1px solid black; font-family:Barlow; padding: 5px 5px; border-radius: 25px; cursor: pointer; width: 50%;\">AKTIVER<\/button>';\n            $output .= '<\/div>';\n            \n\/\/             $output .= '<p style=\"font-size: 10px; font-family:Barlow; background: white; color: #d20a11; margin-top:10; text-align: center; width: 100%;\">Copy the code it will disappear within 1 minute<\/p>';\n            $output .= '<\/div>';\n\n            $output .= '<div style=\"margin-top: 20px; text-align: center;\">';\n            $output .= '<div id=\"' . esc_attr($coupon_id) . '\" style=\"display: none; background: #d20a11; font-size: 12px; color: #fff; padding: 5px 0px; border-radius: 5px; margin-bottom: 10px; font-family:Barlow;\">';\n            $output .= '<strong>' . esc_html($coupon_code) . '<\/strong>';\n            $output .= '<\/div>';\n            $output .= '<\/div>';\n            $output .= '<\/div>';\n\n            $counter++;\n        }\n\n        $output .= '<\/div>';\n\n        $output .= '<script>\n        function showCouponCode(couponId, couponCode) {\n            var couponBox = document.getElementById(couponId);\n            if (couponBox) {\n                couponBox.style.display = \"block\";\n                setTimeout(function() {\n                    couponBox.style.display = \"none\";\n                    var card = document.querySelector(\"[data-coupon=\\'\" + couponCode + \"\\']\");\n                    if (card) card.style.display = \"none\";\n                    var xhr = new XMLHttpRequest();\n                    xhr.open(\"POST\", \"' . admin_url('admin-ajax.php') . '\", true);\n                    xhr.setRequestHeader(\"Content-Type\", \"application\/x-www-form-urlencoded\");\n                   \n                    xhr.send(\"action=hide_user_coupon&coupon_code=\" + encodeURIComponent(couponCode));\n                }, 60000);\/\/ 1 minute = 60000 ms\n            } else {\n                console.log(\"Coupon box not found for ID: \" + couponId);\n            }\n        }\n\t\t\/\/ Hide Elementor heading div if coupons are available\n        document.addEventListener(\"DOMContentLoaded\", function() {\n            var couponContainer = document.querySelector(\".coupon-card\");\n            var elementorHeading = document.querySelector(\".elementor-element-f487a4e\");\n            if (couponContainer && elementorHeading) {\n                elementorHeading.style.display = \"none\";\n            }\n\t\t\t});\n        <\/script>';\n    }\n\n    return $output;\n}\nadd_shortcode('display_user_coupons', 'display_user_valid_coupons_shortcode');\n\n\/\/ AJAX: Save hidden coupon code in user meta\nadd_action('wp_ajax_hide_user_coupon', function () {\n    if (!is_user_logged_in()) {\n        wp_send_json_error('Not logged in');\n    }\n\n    $user_id = get_current_user_id();\n    $coupon_code = sanitize_text_field($_POST['coupon_code'] ?? '');\n\n    if (!$coupon_code) {\n        wp_send_json_error('No coupon code');\n    }\n\n    $hidden = get_user_meta($user_id, 'hidden_coupons', true);\n    if (!is_array($hidden)) {\n        $hidden = [];\n    }\n\n    if (!in_array($coupon_code, $hidden)) {\n        $hidden[] = $coupon_code;\n        update_user_meta($user_id, 'hidden_coupons', $hidden);\n    }\n\n    wp_send_json_success('Hidden');\n});\n","active":true,"modified":"2025-05-11 07:38:46","revision":"73"}]}